---
title: "ã€Goã€‘ã“ã‚ŒãŒä¿ºãªã‚Šã®nrslogã€New Relic APMã€‘"
emoji: "ğŸŸ©"
type: "tech"
topics:
  - "go"
  - "å€‹äººé–‹ç™º"
  - "oss"
  - "newrelic"
  - "observability"
published: true
published_at: "2024-02-27 12:38"
---

:::message
æœ¬è¨˜äº‹ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹å†…å®¹ã¯`newrelic/go-agent@v3.34.0`ä»¥å‰ã®ã‚‚ã®ã§ã™
https://github.com/newrelic/go-agent/releases/tag/v3.34.0
:::
## TL;DR

- `nrslog`ã§ã¯APM Agentå˜ä½“ã§`slog.Attr`ã‚’è»¢é€ã§ããªã„
- ãªã®ã§**ä¿ºãªã‚Šã®nrslog**ã‚’ä½œã‚Šã¾ã—ãŸ

## nrslogã¨ã¯

https://github.com/newrelic/go-agent/tree/master/v3/integrations/logcontext-v2/nrslog

New Relicå…¬å¼ãŒå…¬é–‹ã—ã¦ã„ã‚‹[go-agent](https://github.com/newrelic/go-agent)ã®ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§
`log/slog`ã§Logs in Context[^1]ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™

`NRHandler`ã‚’`slog.Logger`ã®ãƒãƒ³ãƒ‰ãƒ©ã«è¨­å®šã™ã‚‹ã“ã¨ã§ç°¡å˜ã«è¨ˆè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™

è©³ã—ãã¯[example](https://github.com/newrelic/go-agent/blob/master/v3/integrations/logcontext-v2/nrslog/example/main.go)å‚ç…§

## ãªãœ`slog.Attr`ãŒè»¢é€ã•ã‚Œãªã„ã®ã‹

ãã®ç†ç”±ã¯NRHandlerã®å®Ÿè£…ã«ã‚ã‚Šã¾ã™

https://github.com/newrelic/go-agent/blob/487703c7e3df7793cdcf0e2ad7a5f25a6ed90ece/v3/integrations/logcontext-v2/nrslog/handler.go#L129-L142

Go Agentã‚’åˆ©ç”¨ã—ãŸãƒ­ã‚°è»¢é€ã¯ã‚ãã¾ã§`Transaction.RecordLog`ã‚’é€šã˜ã¦New Relicã«é€ä¿¡ã•ã‚Œã‚‹Eventã®ä¸€ç¨®ã§ã€io.Writerã®å‡ºåŠ›ã‚’ãã®ã¾ã¾ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„
ã¨ã„ã†ã®ãŒç­†è€…ã®èªè­˜ã§ã™

ä¸Šè¨˜å®Ÿè£…ã§ã¯ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’`Transaction.RecordLog`ã«æ¸¡ã—ã¦ã„ã‚‹ãŸã‚ã€å¾Œç¶šã®å‡¦ç†ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹`slog.Attr`ã‚‚ã¨ã„`...args`ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“

*(2024/03/01 è¿½è¨˜)*
ãŸã ã—ã“ã‚Œã¯å¾Œè¿°ã™ã‚‹ã‚­ãƒ¼é …ç›®ã‚’ç¢ºå®Ÿã«å«ã¾ã›ã‚‹æ„å›³ãŒã‚ã£ã¦ã®å®Ÿè£…ã ã¨æ€ã‚ã‚Œã¾ã™
https://docs.newrelic.com/jp/docs/logs/ui-data/long-logs-blobs/#data-retention

å‚è€ƒã«`newrelic/go-agent/v3/integrations/logcontext-v2/nrzap`ã®å®Ÿè£…ã§ã™ãŒ
nrslogåŒæ§˜ã«æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚“ã§ã„ã¾ã›ã‚“

https://github.com/newrelic/go-agent/blob/487703c7e3df7793cdcf0e2ad7a5f25a6ed90ece/v3/integrations/logcontext-v2/nrzap/nrzap.go#L118-L122

https://github.com/newrelic/go-agent/blob/487703c7e3df7793cdcf0e2ad7a5f25a6ed90ece/v3/integrations/logcontext-v2/nrzap/nrzap.go#L27-L40

ä¸Šè¨˜ã«ã¤ã„ã¦ã¯ã‚¤ã‚·ãƒ¥ãƒ¼ãŒæŒ™ãŒã£ã¦ã„ã¾ã™ãŒã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼ã‹ã‚‰ã¯å‰å‘ããªå›ç­”ãŒã‚ã‚Šã¾ã—ãŸ
https://github.com/newrelic/go-agent/issues/768

## `slog.Attr`ã‚’è»¢é€ã™ã‚‹ã«ã¯

è‚å¿ƒã®`slog.Attr`ã¯`slog.commonHandler.handle`å†…ã§

1. ãƒãƒ¼ã‚·ãƒ£ãƒªãƒ³ã‚°
1. `slog.Record.Message`ã¨ãƒãƒ¼ã‚¸

ã®å¾Œã«`[]byte`ã¨ã—ã¦`io.Writer.Write`ã«æ¸¡ã•ã‚Œã¦ã„ã¾ã™

`Write`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§`Transaction.RecordLog`ã‚’å‘¼ã³å‡ºã™`io.Writer`å®Ÿè£…ã‚’`slog.commonHandler`ã«è¨­å®šã™ã‚‹ã—ã‹ãªã•ã’ã§ã™

https://github.com/golang/go/blob/2b72395eadcc46120b27b9689bed84338de5141c/src/log/slog/handler.go#L265-L315

## ãã®ä»– Logs in Contextã‚’å®Ÿç¾ã™ã‚‹ä¸Šã§ã®ç•™æ„ç‚¹

ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿(ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆ)ã«ã¯ã‚­ãƒ¼ã¨ãªã‚‹ã„ãã¤ã‹ã®é …ç›®ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™
ä»Šå›ãã¡ã‚‰ã®èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ãŒã€å‚è€ƒã«ã—ãŸãƒªãƒ³ã‚¯ã‚’è²¼ã£ã¦ãŠãã¾ã™

https://developers.prtimes.jp/2023/09/07/newrelic_extension/#index_id14

https://budougumi0617.github.io/2021/03/21/release_nrzap_for_newrelic_logs_in_context/

## ä½œã£ãŸã‚‚ã®

å®Ÿéš›ã«ä½œã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™
ç¾çŠ¶ç”¨æ„ã—ã¦ã„ã‚‹ãƒãƒ³ãƒ‰ãƒ©ã¯`TransactionalHandler`ã®ä¸€ç¨®ã®ã¿ã§ã™

https://github.com/miyamo2/altnrslog

`TransactionalHandler`ã‚’ä½¿ç”¨ã™ã‚‹ä¸Šã§ã¯Transactionå˜ä½ã§`slog.Logger`ã‚’ç”Ÿæˆã—ã¦æŒã¡ã¾ã‚ã™å¿…è¦ãŒã‚ã‚Šã¾ã™

ãªã®ã§ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«

1. `slog.Logger`ã®ç”Ÿæˆ
1. `context.Context`ã¸ã®æ ¼ç´

ã‚’è¡Œã†ã‚«ã‚¹ã‚¿ãƒ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½œã£ã¦è²°ã†ã®ãŒä¸€ç•ªä½¿ã„ã‚„ã™ã„ã‹ãªã¨æ€ã£ã¦ã¾ã™

è›‡è¶³ãªæ°—ã‚‚ã—ã¤ã¤ã€`context.Context`ã‹ã‚‰ã®å‡ºã—å…¥ã‚Œç”¨ã®é–¢æ•°ã ã‘ç”¨æ„ã—ã¾ã—ãŸ

https://github.com/miyamo2/altnrslog/blob/44754f8877ecf55853bbd7f9f936ecbaf3e149a1/context.go#L18-L40

å…·ä½“çš„ãªä½¿ã„æ–¹ã¯READMEã‚‚ã—ãã¯ã€pkg.go.devã®Examplesã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„
https://pkg.go.dev/github.com/miyamo2/altnrslog#example-package

ä»¥ä¸‹ãŒå®Ÿéš›ã«altnrslogã§è»¢é€ã•ã‚ŒãŸãƒ­ã‚°ã§ã™

å®Ÿè¡Œç’°å¢ƒã¯ECS on Fargate

![å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸](https://storage.googleapis.com/zenn-user-upload/98897668ad7f-20240227.png)

ãã‚Œã§ã¯ã€ã‚ˆãã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã‚’

[^1]: [Introduction to logs in context](https://docs.newrelic.com/docs/logs/logs-context/logs-in-context/)