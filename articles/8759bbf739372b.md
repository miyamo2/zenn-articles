---
title: "Go 1.23 range over funcã“ã¨ã¯ã˜ã‚: ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ã‚¤ãƒ³ã§æ›¸ã‘ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ðŸ†•"
type: "tech"
topics:
  - "go"
  - "å€‹äººé–‹ç™º"
  - "iterator"
  - "rangeoverfunc"
published: true
published_at: "2024-08-01 18:45"
publication_name: "comsize_press"
---

## ã¯ã˜ã‚ã« - range over funcã¨ã¯

Go 1.22ã‹ã‚‰Previewã¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€Go 1.23ã§æ­£å¼ãƒªãƒªãƒ¼ã‚¹äºˆå®šã¨ãªã£ã¦ã„ã‚‹æ©Ÿèƒ½ã§ã„ã‚ã‚†ã‚‹ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™

https://github.com/golang/go/issues/61405

`database/sql`ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ãª`HasNext`ã§å­˜åœ¨ç¢ºèªã€`Next`ã§ã‚«ãƒ¼ã‚½ãƒ«ã‚’é€²ã‚ã‚‹`next-based|pull-based`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§ãªãã€for rangeæ§‹æ–‡ã¨çµ±åˆã•ã‚ŒãŸ`yield-based|push-based`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãŒæŽ¡ç”¨ã•ã‚Œã¦ã„ã¾ã™
```go
// next-based(pull-based)
for pullIter.HasNext() {
	pullIter.Next()
	pullIter.Something()
}

// yield-based(push-based)
for k, v := range pushIter {
	fmt.Printf("%v: %v\n")
}
```

## yieldã¨range over func

`yield`ã¯Pythonç­‰ã¨é•ã„äºˆç´„èªžã§ã¯ãªãã€å¼•æ•°ã‚’0ï½ž2ã¤å–ã£ã¦boolã‚’è¿”ã™é–¢æ•°ã¨ãªã£ã¦ã„ã¾ã™
`yield`ã¯ãƒ«ãƒ¼ãƒ—ãŒç¶™ç¶šã•ã‚Œã¦ã„ã‚Œã°(ä¸­æ–­ã•ã‚Œã¦ã„ãªã‘ã‚Œã°)`true`ã€ç¶™ç¶šã•ã‚Œã¦ã„ãªã‘ã‚Œã°(ä¸­æ–­ã•ã‚Œã¦ã„ã‚Œã°)`false`ã‚’è¿”ã—ã¾ã™

(ã‚ãã¾ã§ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œã‚’è¸ã¾ãˆã¦ã®æŽ¨è«–ã§ã™ãŒ...)`range over func`ã‚’ç”¨ã„ãŸfor rangeã§ã¯forãƒ–ãƒ­ãƒƒã‚¯å†…ã®å‡¦ç†ãŒ`:= range`ã®å·¦è¾ºã«å¿œã˜ã¦`func() bool`ã€`func(T) bool`ã‚‚ã—ãã¯`func(T, U) bool`ã®ã„ãšã‚Œã‹ã«ãƒ©ãƒƒãƒ—ã•ã‚Œã€`yield`ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™

```go
for i, v := range someIter {
    fmt.Sprintf("%d: %s", i, v)
}
```

```go
// â€»ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™
func(i int, v string) (called bool) {
    // ä¸æ€è­°ãªåŠ›ã«ã‚ˆã£ã¦calledãŒè§£æ±ºã•ã‚Œã‚‹
    fmt.Sprintf("%d: %s", i, v) 
    return
}
```

`range over func`ã¯`range`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§`yield`ã‚‚ã¨ã„ã€forãƒ–ãƒ­ãƒƒã‚¯å†…ã®å‡¦ç†ã‚’å—ã‘å–ã£ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹é–¢æ•°ã§ã™
`yield`ãŒfalseã‚’è¿”ã—ãŸéš›ã€ã¤ã¾ã‚Šfor rangeãŒä¸­æ–­ã•ã‚ŒãŸå ´åˆã«ã¯å‡¦ç†ã‚’çµ‚äº†ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

```go
s := []int{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11}
sq := iter.Seq[int](func(yield func(int) bool) {
    for _, v := range s {
        if v%2 == 0 && !yield(v) {
            return
        }
    }
})
```

`range over func`è‡ªä½“ã¯ãŸã ã®é–¢æ•°ãªã®ã§å‹¿è«–for rangeä»¥å¤–ã‹ã‚‰`range over func`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™
ãã®å ´åˆã¯breakã‚’ã—ãªã„for rangeã¨åŒç­‰ã®æŒ™å‹•ã¨ãªã‚‹èªè­˜ã§ã™
```go
s := []int{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11}
sq := iter.Seq[int](func(yield func(int) bool) {
    for _, v := range s {
        if v%2 == 0 && !yield(v) {
            return
        }
    }
})

//for v := range sq {
//    fmt.Printf("%d\n", v)
//}
sq(func(v int) bool {
    fmt.Printf("%d\n", v)
}
// Output: 2
//4
//6
//8
//10
```

https://go.dev/play/p/kLRhmQZ37_K?v=gotip

## ä½œã£ãŸã‚‚ã® - xtract

https://github.com/miyamo2/xtract

```go
package main

import (
	"fmt"
	"github.com/miyamo2/xtract"
	"strings"
)

func main() {
	s := []int{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 100, 101}
	xt := xtract.FromSlice(s)
	even := xt.ByValue(func(i int) bool { return i%2 == 0 })
	odd := xt.ByValue(func(i int) bool { return i%2 != 0 })

	fmt.Println("---even---")
	for v := range even.Values() {
		fmt.Println(v)
	}

	fmt.Println("---odd---")
	for v := range odd.Values() {
		fmt.Println(v)
	}

	evenAndTwoDigits := even.ByValue(func(i int) bool { return i > 9 && i < 100 })
	fmt.Println("---even and two digits---")
	for v := range evenAndTwoDigits.Values() {
		fmt.Println(v)
	}

	oddAndTwoDigits := odd.ByValue(func(i int) bool { return i > 9 && i < 100 })
	fmt.Println("---odd and two digits---")
	for v := range oddAndTwoDigits.Values() {
		fmt.Println(v)
	}
	// Output: ---even---
	//0
	//2
	//4
	//6
	//8
	//10
	//100
	//---odd---
	//1
	//3
	//5
	//7
	//9
	//11
	//101
	//---even and two digits---
	//10
	//---odd and two digits---
	//11
}
```

ä¸Šè¨˜ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯`ByValue`ã—ã‹ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ãŒã€

- å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã™ã‚‹å ´åˆã¯`ByValue`
- ã‚­ãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã™ã‚‹å ´åˆã¯`ByKey`
- å€¤ã¨ã‚­ãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã™ã‚‹å ´åˆã¯`ByKeyAndValue`
- å…ˆé ­Nä»¶ã«ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹å ´åˆã¯`Limit`
- å…ˆé ­Nä»¶ä»¥é™ã«ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹å ´åˆã¯`Offset`

ã¨ã„ã£ãŸå½¢ã§ä½¿ã„åˆ†ã‘ã¦ãã ã•ã„

`ByValue`ã€`ByKeyAndValue`ã€`Limit`ã¯Russ CoxãŒãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ã‚’å‡ºã—ã¦ã„ã‚‹[`x/exp/xiter`](https://github.com/golang/go/issues/61898)ã®`Filter[V any]`ã€`Filter2[K,V any]`ã€`Limit[V any]`ã¨ãŠãŠã‚€ã­åŒã˜å®Ÿè£…ã§ã™ãŒã€`miyamo2/xtract`ã¯ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ã‚¤ãƒ³ã§æ›¸ã‘ã‚‹ã®ã§Javaã®Stream APIç­‰ã¨è¿‘ã„æ›¸ãå‘³ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™

ã¾ãŸã€`miyamo2/xtract`ã§ã¯å…¨ã¦ã®ä¸­é–“å‡¦ç†ã¯çµ‚ç«¯å‡¦ç†(ç¾çŠ¶`Values`ã®ã¿)ãŒå‘¼ã°ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è©•ä¾¡ã•ã‚Œã‚‹ãŸã‚ã€ãã†ã„ã£ãŸç‚¹ã§ã‚‚Stream APIã¨è¿‘ã„ã¨ã„ãˆã¾ã™
ä¾‹ã¨ã—ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®`even`ã¨`evenAndTwoDigits`ã§ã¯`FromSlice(s)`ã‹ã‚‰`ByValue(func(i int) bool { return i%2 == 0 })`ã¾ã§ã®ä¸­é–“å‡¦ç†ãŒãã‚Œãžã‚Œã®çµ‚ç«¯å‡¦ç†ã§å®Ÿè¡Œã•ã‚Œã‚‹æŒ™å‹•ã¨ãªã£ã¦ã„ã¾ã™

ç¾çŠ¶ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¥ã®åž‹ã«åŠ å·¥ã™ã‚‹ã„ã‚ã‚†ã‚‹mapãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã§ãã¦ã„ãªã„ã®ã§ã™ãŒã€ã‚ãã¾ã§åž‹å®‰å…¨ã«ã“ã ã‚ã‚ŠãŸã‹ã£ãŸã“ã¨ã‚„ã€GoãŒä»Šå¾Œå¯å¤‰é•·åž‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã¸ã®æœŸå¾…ã‚‚è¾¼ã‚ã¦ä»Šã¯ç„¡ç†ã«å®Ÿè£…ã—ãªã„ã“ã¨ã«ã—ã¾ã—ãŸ

### ä½™è«‡

`v0.1.0`æ™‚ç‚¹ã§ã¯å…ƒãƒã‚¿ã®slice, mapã‚’ãã‚Œãžã‚Œä¿æŒã—ã¦ã„ãŸéƒ½åˆã§`SliceExtractor[V any]`ã€`MapExtractor[K comparable, V any]`ã¨å®Ÿè£…ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€`iter.Seq2[K, V any]`ã‚’ä¿æŒã™ã‚‹å½¢ã«å¤‰æ›´ã—ãŸãŸã‚ã€ç„¡ç”¨ã®é•·ç‰©ã¨ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸ
ãªã‚“ã¨ã‹ã—ã¦å®Ÿè£…ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ´»ã‹ã—ãŸã„ã®ã§è‰¯ãã‚¢ã‚¤ãƒ‡ã‚¢ã®ã‚ã‚‹æ–¹ã¯æ˜¯éžPRã‹Issueã‚’é€ã£ã¦ãã ã•ã„...ï¼(å‹¿è«–ãã‚Œä»¥å¤–ã®å†…å®¹ã‚‚å¤§æ­“è¿Žã§ã™)

## range over funcã‚’è§¦ã£ã¦ã¿ãŸæ‰€ç®¡

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–‹ç™ºã®å ´é¢ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤§ããªåˆ©ä¾¿æ€§ã‚’æä¾›ã§ãã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸ

å€‹äººçš„ã«`database/sql`ãŒä¸€ç•ªå¯¾å¿œã—ã¦ã»ã—ã„æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™

## è¿½ä¼¸: miyamo2/filtgen

æ§‹é€ ä½“ã®å®šç¾©ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹CLIã‚‚ä½œã£ã¦ã¿ã¾ã—ãŸ

https://zenn.dev/comsize_press/articles/30985199012029
